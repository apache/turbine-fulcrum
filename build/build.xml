<?xml version="1.0"?>

<!-- Build file for Turbine -->

<project name="Fulcrum" default="jar" basedir=".">

  <!-- Allow any user specific values to override the defaults -->
  <property file="${user.home}/build.properties" />

  <!-- Set default values for the build -->
  <property file="build.properties" />

  <property name="build.src" value="${build.dir}/src"/>
  <property name="build.dest" value="${build.dir}/classes"/>
  <property name="src.java.dir" value="${src.dir}/java"/>
  <property name="src.test.dir" value="${src.dir}/test"/>
  <property name="src.dtd.dir" value="${src.dir}/dtd"/>
  <property name="final.name" value="${project}-${version}"/>
  <property name="final.dir" value="../${final.name}/"/>

  <!-- ================================================================== -->
  <!-- E N V I R O N M E N T                                             -->
  <!-- ================================================================== -->
  
  <target name="env">
    <echo message="java.home = ${java.home}"/>
    <echo message="user.home = ${user.home}"/>
    <echo message="java.class.path = ${java.class.path}"/>
    <echo message=""/>
  </target>

  <!-- Construct compile classpath -->
  <path id="classpath">
    <pathelement location="${log4j.jar}"/>

    <!-- BSFService -->
    <pathelement location="${bsf.jar}"/>

    <!-- VelocityService and Torque gen -->
    <pathelement location="${velocity.jar}"/>
    
    <!-- DBService -->
    <pathelement location="${village.jar}"/>
    <pathelement location="${jdbc.jar}"/>
    <pathelement location="${torque.jar}"/>
    
    <!-- IntakeService -->
    <pathelement location="${regexp.jar}"/>
    
    <!-- XmlRpcService -->
    <pathelement location="${xmlrpc.jar}"/>
    
    <!-- XSLTService -->
    <pathelement location="${xalan.jar}"/>
    
    <!-- these have to go -->
    <pathelement location="${xerces.jar}"/>
    <pathelement location="${servlet.jar}"/>
    <pathelement location="${javamail.jar}"/>
    <pathelement location="${jaf.jar}"/>
  </path>

  <!-- ================================================================== -->
  <!-- U S A G E                                                          -->
  <!-- ================================================================== -->
  
  <target name="usage">
    <echo message="use -projecthelp to see the available targets"/>
  </target>

  <!-- ================================================================== -->
  <!-- I N I T                                                            -->
  <!-- ================================================================== -->

  <target name="init">
    <available 
      classname="org.apache.velocity.anakia.AnakiaTask"
      property="AnakiaTask.present"
      classpathref="classpath"
    />
    
    <available 
      classname="org.apache.velocity.runtime.Runtime"
      property="velocity.present"
      classpathref="classpath"
    />
    
    <available 
      classname="com.workingdogs.village.Column"
      property="village.present"
      classpathref="classpath"
    />
  </target>

  <!-- ================================================================== -->
  <!-- P R O P E R T Y  C H E C K S  A N D  W A R N I N G S               -->
  <!-- ================================================================== -->

  <target name="check.velocity" unless="velocity.present">
    <antcall target="property-warning">
      <param name="name" value="velocity.jar"/>
      <param name="value" value="${velocity.jar}"/>
    </antcall>
  </target>

  <target name="check.village" unless="village.present">
    <antcall target="property-warning">
      <param name="name" value="village.jar"/>
      <param name="value" value="${village.jar}"/>
    </antcall>
  </target>

  <target name="property-warning">
    <echo>
      +----------------------------------------------------------------+
      + F A I L E D  R E Q U I R E M E N T                             |
      +----------------------------------------------------------------+
      | You must define the following property in order                |
      | to build Torque:                                               |
      |                                                                |
      | ${name} 
      |                                                                |
      | You can set this property in the provided build.properties     |
      | file, or you may set this property in your                     |
      | ${user.home}/build.properties file.                            
      +----------------------------------------------------------------+
    </echo>
    <fail message="Failed Requirement"/>
  </target>

  <!-- ================================================================== -->
  <!-- P R E P A R E                                                      -->
  <!-- ================================================================== -->
  
  <target name="prepare" 
    depends="init,
             check.velocity,
             check.village,
             env">
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${build.dest}"/>
    <mkdir dir="${build.src}"/>

    <filter token="VERSION" value="${version}"/>

    <copy todir="${build.src}/org" filtering="yes">
      <fileset dir="${src.java.dir}/org"/>
    </copy>
        
  </target>

  <!-- ================================================================== -->
  <!-- C O M P I L E                                                      -->
  <!-- ================================================================== -->
  
  <target name="compile" depends="prepare,om"
          description="--> compiles the source code">
    <javac srcdir="${build.src}"
      destdir="${build.dest}"
      excludes="**/package.html"
      debug="${debug}"
      deprecation="${deprecation}"
      optimize="${optimize}">
      <classpath refid="classpath"/>
    </javac>
  </target>

  <!-- ================================================================== -->
  <!-- J A R                                                              -->
  <!-- ================================================================== -->
  
  <target name="jar" depends="compile" description="--> generates the torque.jar">
    <jar jarfile="${build.dir}/${final.name}.jar"
         basedir="${build.dest}"
         excludes="**/package.html"/>
  </target>

  <!-- ================================================================== -->
  <!-- J A V A D O C S                                                    -->
  <!-- ================================================================== -->
  
  <target name="javadocs"
            depends="prepare"
            description="--> generates the API documentation">
    <mkdir dir="${javadoc.destdir}"/>
    
    <javadoc
      sourcepath="${build.src}"
      packagenames="org.apache.turbine.services.*"
      destdir="${javadoc.destdir}"
      author="true"
      private="true"
      version="true"
      use="true"
      windowtitle="${name} ${version} API"
      doctitle="${name} ${version} API"
      bottom="Copyright &amp;copy; ${year} Apache Software Foundation. All Rights Reserved."
      >
      <classpath refid="classpath"/>
    </javadoc>
  </target>

  <!-- ================================================================== -->
  <!-- C L E A N                                                          -->
  <!-- ================================================================== -->
  
  <target name="clean" description="--> cleans up the build directory">
    <delete dir="${build.dir}"/>
  </target>

  <!-- ================================================================== -->
  <!-- A N A K I A  D O C U M E N T A T I O N                             -->
  <!-- ================================================================== -->
  
  <target name="check_for_jdom">
    <available 
      property="jdom.present"
      classname="org.jdom.JDOMException">
      <classpath>
        <pathelement location="${jakarta.site2}/lib/${jdom.jar}"/>
      </classpath>
    </available>
  </target>
  
  <target depends="check_for_jdom" name="docs-prepare-error"
          unless="jdom.present">
    <echo>
      The Jakarta-Site2 module is not present! Please check
      to make sure that you have checked it out from CVS.

      &lt;http://jakarta.apache.org/site/jakarta-site2.html&gt;
    </echo>
  </target>

  <target name="docs"
          depends="docs-prepare-error"
          description="--> generates the HTML documentation"
          if="jdom.present">

    <taskdef name="anakia"
       classname="org.apache.velocity.anakia.AnakiaTask">
       <classpath>
         <fileset dir="${jakarta.site2}/lib">
           <include name="*.jar"/>
         </fileset>
       </classpath>
     </taskdef>

     <anakia 
       basedir="${docs.src}" 
       destdir="${docs.dest}/"
       extension=".html" style="./site.vsl"
       projectFile="stylesheets/project.xml"
       excludes="**/stylesheets/** empty.xml"
       includes="**/*.xml"
       lastModifiedCheck="true"
       templatePath="${jakarta.site2}/xdocs/stylesheets">
     </anakia>

     <copy todir="${docs.dest}/images" filtering="no">
       <fileset dir="${docs.src}/images">
         <include name="**/*.gif"/>
         <include name="**/*.jpeg"/>
         <include name="**/*.jpg"/>
       </fileset>
     </copy>
     
     <!-- In case we have CSS someday
     <copy todir="${docs.dest}" filtering="no">
       <fileset dir="${docs.src}">
         <include name="**/*.css"/>
       </fileset>
     </copy>
     -->
  </target>

  <!-- ================================================================== -->
  <!-- Create the Turbine SQL for all the supported DBs.                  -->
  <!-- ================================================================== -->
  
  <target name="check-om">
    <uptodate 
      property="omGenerated"
      targetfile="${omStatusFile}">
      <srcfiles dir="${conf.dir}/master" includes="turbine-schema.xml"/>
    </uptodate>
  </target>

  <target name="om" 
          depends="check-om" 
          unless="omGenerated"
          description="--> generates the Turbine OM/Peer classes">
        
    <ant antfile="build-om.xml" dir="${basedir}"/>
  </target>
</project>
