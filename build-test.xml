<?xml version="1.0"?>

<project name="Stratum" default="test" basedir=".">

  <!-- Allow any user specific values to override the defaults -->
  <property file="${user.home}/build.properties" />
  <!-- Allow user defaults for this project -->
  <property file="build.properties" />
  <!-- Set default values for the build -->
  <property file="default.properties" />

  <!-- Construct compile classpath -->
  <path id="classpath">
    <pathelement location="${bsf.jar}"/>
    <pathelement location="${commons-collections.jar}"/>
    <pathelement location="${commons-email.jar}"/>
    <pathelement location="${commons-util.jar}"/>
    <pathelement location="${jaf.jar}"/>
    <pathelement location="${javamail.jar}"/>
    <pathelement location="${jdbc.jar}"/>
    <pathelement location="${jndi.jar}"/>
    <pathelement location="${log4j.jar}"/>
    <pathelement location="${regexp.jar}"/>
    <pathelement location="${servlet.jar}"/>
    <pathelement location="${torque.jar}"/>
    <pathelement location="${velocity.jar}"/>
    <pathelement location="${village.jar}"/>
    <pathelement location="${xalan.jar}"/>
    <pathelement location="${xerces.jar}"/>
    <pathelement location="${xmlrpc.jar}"/>
    <pathelement location="${build.dest}"/>
    <pathelement location="${junit.jar}"/>
  </path>

  <!-- ================================================================== -->
  <!-- T E S T                                                            -->
  <!-- ================================================================== -->

  <target 
    name="test" 
    depends="compile-test" 
    description="runs (junit) unit tests">

    <delete dir="${test.reportsDirectory}"/>
    <mkdir dir="${test.reportsDirectory}"/>

    <echo>
      Running all JUnit tests
    </echo>
    
    <junit printSummary="yes">
      <formatter type="plain"/>
      <classpath refid="classpath"/>
      <batchtest todir="${test.reportsDirectory}">
        <fileset dir="${build.dest}">
          <include name="**/*Test*.class"/>
          <exclude name="**/LocaleTokenizerTest.class"/>
          <exclude name="**/LocalizationTest.class"/>
        </fileset>
      </batchtest>
    </junit>

    <java
      classname="org.apache.fulcrum.localization.LocalizationTest"
      fork="yes" failonerror="true">
      <classpath>
        <path refid="classpath"/>
        <pathelement location="${build.dir}/classes"/>
        <pathelement location="${build.dir}/test"/>
      </classpath>
    </java>

    <java
      classname="org.apache.torque.test.FulcrumRunner">
      <arg value="${rttest.dir}/Fulcrum.properties"/>
      <classpath refid="classpath"/>
    </java>

  </target>

  <!-- ================================================================== -->
  <!-- C O M P I L E  T E S T S                                           -->
  <!-- ================================================================== -->

  <target
    name="compile-test"
    description="==> compiles the test source code">
    
    <ant antfile="build.xml" target="compile"/>
    
    <javac
      destdir="${build.dest}"
      excludes="**/package.html"
      debug="${debug}"
      deprecation="${deprecation}"
      optimize="${optimize}">
      <src path="${test.dir}"/>
      <src path="${rttest.dir}"/>
      <classpath refid="classpath"/>
      <classpath>
        <pathelement path="${build.dest}"/>
      </classpath>
    </javac>
  </target>

</project>
