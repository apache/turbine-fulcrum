<project name="Turbine SQL" default="main" basedir=".">

  <!-- Allow any user specific values to override the defaults -->
  <property file="${user.home}/build.properties" />
  <!-- Allow user defaults for this project -->
  <property file="build.properties" />
  <!-- Set default values for the build -->
  <property file="default.properties" />

  <property name="omStatusFile" value="${build.dir}/report.turbine.om.generation"/>

  <!-- ================================================================ -->
  <!-- I N I T  T A R G E T                                             -->
  <!-- ================================================================ -->
  <!-- We are placing the taskdef initialization in a target of its     -->
  <!-- because the classpath will not be loaded within the taskdef      -->
  <!-- if the taskdef is a child of the project. It must be placed      -->
  <!-- with a target to work. This is a work around for a problem       -->
  <!-- in Ant, but it solves the problem of not having to alter         -->
  <!-- the classpath in the .sh|.bat scripts.                           -->
  <!-- ================================================================ -->

  <target name="init">
    <taskdef name="torque-om"
      classname="org.apache.torque.task.TorqueObjectModelTask">
      <classpath>
        <pathelement location="${velocity.jar}"/>
        <pathelement location="${log4j.jar}"/>
        <pathelement location="${torque.jar}"/>
        <pathelement location="${xerces.jar}"/>
        <pathelement location="${commons-collections.jar}"/>
        <pathelement location="${commons-lang.jar}"/>
        <pathelement location="${commons-util.jar}"/>
        <pathelement location="${stratum.jar}"/>
      </classpath>
    </taskdef>
  </target>

  <!-- ================================================================ -->
  <!-- M A I N  T A R G E T                                             -->
  <!-- ================================================================ -->
  <!-- Generate Turbine SQL schema for supported DBs                    -->
  <!-- ================================================================ -->

  <target name="main" depends="init">
    <antcall target="security-om"/>
    <antcall target="scheduler-om"/>
  </target>


  <target name="security-om" depends="init">

    <filter token="DATABASE_DEFAULT" value="${security.database.name}"/>
    <!-- is there a way to load this from an xml file? -->
    <filter token="EXTRA_USER_COLUMNS" value="${security.extra.user.columns}"/>
    <copy
      todir="${build.src}"
      file="${schemaDirectory}/turbine-schema.xml"
      filtering="yes"
    />

    <torque-om
      contextProperties="default.properties"
      controlTemplate="${OMControlTemplate}"
      outputDirectory="${src.dir}/services/java"
      templatePath="${templatePath}"
      outputFile="report.turbine.om.generation"
      targetPackage="${securityPackage}"
      xmlFile="${build.src}/turbine-schema.xml"
      targetDatabase="${database}"
    />

  </target>


  <target name="scheduler-om" depends="init">

    <filter token="DATABASE_DEFAULT" value="${scheduler.database.name}"/>
    <copy
      todir="${build.src}"
      file="${schemaDirectory}/scheduler-schema.xml"
      filtering="yes"
    />

    <torque-om
      contextProperties="default.properties"
      controlTemplate="${OMControlTemplate}"
      outputDirectory="${src.dir}/services/java"
      templatePath="${templatePath}"
      outputFile="report.turbine.scheduler.generation"
      targetPackage="${schedulerPackage}"
      xmlFile="${build.src}/scheduler-schema.xml"
    />

  </target>

</project>
